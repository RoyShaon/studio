<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ত্রিফুল আরোগ্য নিকেতন - সম্পূর্ণ প্রজেক্ট কাঠামো</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        @layer base {
          :root {
            --background: 220 20% 97%; /* Muted light blue-gray */
            --foreground: 220 15% 20%;
            --card: 0 0% 100%;
            --card-foreground: 220 15% 20%;
            --popover: 0 0% 100%;
            --popover-foreground: 220 15% 20%;
            --primary: 230 80% 60%; /* Indigo-like blue */
            --primary-foreground: 0 0% 100%;
            --secondary: 220 15% 90%;
            --secondary-foreground: 220 15% 20%;
            --muted: 220 15% 90%;
            --muted-foreground: 220 10% 45%;
            --accent: 220 20% 94%;
            --accent-foreground: 220 15% 20%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 220 15% 85%;
            --input: 220 15% 85%;
            --ring: 230 80% 60%;
            --chart-1: 12 76% 61%;
            --chart-2: 173 58% 39%;
            --chart-3: 197 37% 24%;
            --chart-4: 43 74% 66%;
            --chart-5: 27 87% 67%;
            --radius: 0.5rem;
          }
        }

        @layer base {
          * {
            @apply border-border;
          }
          body {
            @apply bg-background text-foreground;
            font-family: 'Hind Siliguri', 'Inter', sans-serif;
          }
        }
        
        .prescription-sheet {
            padding: 2rem 1.5rem; 
            max-width: 450px;
            height: 660px;
            margin: 2rem auto;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .instruction-box {
            border: 1px dashed #6b7280;
            padding: 0.75rem; 
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        .advice-list li {
            margin-bottom: 0.1rem; 
        }

        #counseling-content {
          display: none;
        }
        #counseling-trigger.open + #counseling-content {
          display: block;
        }

        @media print {
          body {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            background-color: white !important;
          }
          body > *:not(#printable-content) {
            display: none !important;
          }

          #printable-content {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
          }
          
          .print-page {
            page-break-after: always;
            display: flex !important;
            align-items: center;
            justify-content: center;
            visibility: visible !important;
            background-color: white !important;
            width: 100% !important;
            height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 10pt !important;
            box-sizing: border-box;
          }

          .print-page .prescription-sheet {
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            max-width: 3.6in !important;
            height: 5.6in !important;
            padding: 0.25in !important;
            margin: 0 !important;
            visibility: visible !important;
            border: none !important;
            box-shadow: none !important;
            background-color: white !important;
          }

          .print-page * {
            visibility: visible !important;
            color: #000 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
          
          .print-page .text-base {
            font-size: 11pt !important;
          }
          .print-page .text-sm {
            font-size: 10pt !important;
          }
          .print-page .text-xs {
            font-size: 8pt !important;
          }

          .print-page .text-red-700 {
            color: #b91c1c !important;
          }

          .print-page .text-indigo-700 {
            color: #4338ca !important;
          }
          
          .print-page .instruction-box {
            padding: 0.5rem !important;
            border: none !important;
            line-height: 1.5 !important;
          }

          .print-page .advice-list {
            padding-left: 0 !important;
            list-style: none !important;
          }
          
          .print-page .advice-list li {
            line-height: 1.3 !important;
            margin-bottom: 0 !important;
          }

          .print-page .doctor-info {
            line-height: 1.3 !important;
            margin-top: auto !important;
          }
          .print-page .doctor-info p {
            margin-bottom: 0px !important;
            line-height: 1.3 !important;
          }

          @page {
              size: 3.6in 5.6in;
              margin: 0.1in;
          }
        }
    </style>
    <script>
      tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    body: ['Hind Siliguri', 'Inter', 'sans-serif'],
                    headline: ['Hind Siliguri', 'Inter', 'sans-serif'],
                },
                colors: {
                    background: 'hsl(220 20% 97%)',
                    foreground: 'hsl(220 15% 20%)',
                    card: {
                        DEFAULT: 'hsl(0 0% 100%)',
                        foreground: 'hsl(220 15% 20%)',
                    },
                    popover: {
                        DEFAULT: 'hsl(0 0% 100%)',
                        foreground: 'hsl(220 15% 20%)',
                    },
                    primary: {
                        DEFAULT: 'hsl(230 80% 60%)',
                        foreground: 'hsl(0 0% 100%)',
                    },
                    secondary: {
                        DEFAULT: 'hsl(220 15% 90%)',
                        foreground: 'hsl(220 15% 20%)',
                    },
                    muted: {
                        DEFAULT: 'hsl(220 15% 90%)',
                        foreground: 'hsl(220 10% 45%)',
                    },
                    accent: {
                        DEFAULT: 'hsl(220 20% 94%)',
                        foreground: 'hsl(220 15% 20%)',
                    },
                    destructive: {
                        DEFAULT: 'hsl(0 84.2% 60.2%)',
                        foreground: 'hsl(0 0% 98%)',
                    },
                    border: 'hsl(220 15% 85%)',
                    input: 'hsl(220 15% 85%)',
                    ring: 'hsl(230 80% 60%)',
                }
            }
        }
      }
    </script>
</head>
<body class="bg-background">

    <!-- Section: Main Application Page -->
    <section id="home-page">
        <main class="min-h-screen p-4 sm:p-6 lg:p-8 bg-background">
            <div class="max-w-7xl mx-auto space-y-8">
              <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div>
                  <h1 class="text-4xl font-bold tracking-tight font-body text-indigo-700">
                    ত্রিফুল আরোগ্য নিকেতন
                  </h1>
                  <p class="text-muted-foreground mt-1">
                    প্রয়োজনীয় তথ্য দিয়ে ঔষধের লেবেল তৈরি এবং প্রিন্ট করুন।
                  </p>
                </div>
              </header>
      
              <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                
                <!-- Component: LabelForm -->
                <div class="lg:col-span-2 shadow-lg rounded-lg border bg-card text-card-foreground">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="text-2xl font-semibold leading-none tracking-tight font-body">রোগীর তথ্য ও নির্দেশাবলী</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium leading-none" for="serial">ক্রমিক নং</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="serial" name="serial" value="F/">
                                </div>
                                <div>
                                    <label class="text-sm font-medium leading-none">তারিখ</label>
                                    <input type="date" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="date">
                                </div>
                            </div>

                            <div>
                                <label class="text-sm font-medium leading-none" for="patientName">রোগীর নাম</label>
                                <div class="relative flex items-center">
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm pr-10" id="patientName" name="patientName">
                                    <button type="button" id="mic-button" class="absolute right-1 h-8 w-8 rounded-full flex items-center justify-center bg-transparent hover:bg-gray-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-gray-500"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-6">
                                <div class="flex flex-wrap gap-4" id="shakeMode">
                                    <div class="flex items-center">
                                        <input type="radio" value="with" id="with-shake" name="shakeMode" class="peer sr-only" checked>
                                        <label for="with-shake" class="px-4 py-2 rounded-lg bg-indigo-600 text-white border-2 border-indigo-600 font-semibold transition duration-150 cursor-pointer">ঝাঁকি সহ</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" value="without" id="without-shake" name="shakeMode" class="peer sr-only">
                                        <label for="without-shake" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 border-2 border-transparent hover:border-indigo-600 font-semibold transition duration-150 cursor-pointer">ঝাঁকি ছাড়া</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div id="shake-count-wrapper">
                                        <label class="text-sm font-medium leading-none" for="shakeCount">কত বার ঝাঁকি দিবেন?</label>
                                        <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="shakeCount" name="shakeCount" type="number" value="10">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium leading-none" for="drops">কত ফোঁটা করে খাবেন?</label>
                                        <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="drops" name="drops" type="number" value="3">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium leading-none" for="interval">কত <span id="interval-unit-text">ঘন্টা</span> পর পর খাবেন?</label>
                                        <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="interval" name="interval" type="number" value="12">
                                        <div class="flex gap-4 mt-2" id="intervalUnit">
                                            <div class="flex items-center space-x-2">
                                                <input type="radio" id="hours" name="intervalUnit" value="hours" checked>
                                                <label for="hours">ঘণ্টা</label>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <input type="radio" id="days" name="intervalUnit" value="days">
                                                <label for="days">দিন</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium leading-none" for="mixtureAmount">কিভাবে খাবেন?</label>
                                        <select class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="mixtureAmount" name="mixtureAmount">
                                            <option value="১ চামচ">১ চামচ</option>
                                            <option value="২ চামচ">২ চামচ</option>
                                            <option value="৩ চামচ">৩ চামচ</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="text-sm font-medium leading-none" for="durationDays">কত দিন খাবেন?</label>
                                        <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="durationDays" name="durationDays" type="number" value="7">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium leading-none" for="labelCount">কতগুলো লেবেল?</label>
                                        <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="labelCount" name="labelCount" type="number" value="1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium leading-none" for="followUpDays">কত দিন পরে আসবেন?</label>
                                        <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="followUpDays" name="followUpDays" type="number" value="7">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4 pt-4 border-t">
                                <div id="counseling-trigger" class="flex w-full justify-between items-center text-lg font-semibold cursor-pointer">
                                    <h3>পরামর্শ</h3>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 transition-transform"><path d="m6 9 6 6 6-6"></path></svg>
                                </div>
                                <div id="counseling-content" class="space-y-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium leading-none">বর্তমান পরামর্শসমূহ:</label>
                                        <div class="space-y-1" id="counseling-list">
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium leading-none" for="counseling-select">নতুন পরামর্শ যোগ করুন</label>
                                        <div class="flex gap-2">
                                            <select class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" id="counseling-select">
                                                <option>• ঔষধ সেবনকালীন টক খাওয়া নিষেধ।</option>
                                                <option>• ঔষধ সেবনকালীন দুধ, ডিম, মাংস খাওয়া নিষেধ।</option>
                                                <option>• গোরুর মাংস খাওয়া একদম নিষেধ।</option>
                                            </select>
                                            <button id="add-counseling-btn" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="16"></line><line x1="8" x2="16" y1="12" y2="12"></line></svg>
                                                যোগ করুন
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="flex items-center gap-4" id="show-all-wrapper" style="display: none;">
                                    <div class="flex items-center space-x-2 pt-6">
                                        <input type="checkbox" id="showAllPreviews" class="peer h-4 w-4 shrink-0 rounded-sm border border-primary">
                                        <label for="showAllPreviews">সকল প্রিভিউ দেখুন</label>
                                    </div>
                                </div>
                                <div class="space-y-2" id="slider-wrapper">
                                    <label>কোন লেবেলটি প্রিভিউ করবেন? (<span id="active-label-text">১</span>)</label>
                                    <input type="range" id="activeLabelIndex" min="1" max="1" step="1" value="1" class="w-full">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Component: LabelForm -->
      
                <div class="lg:col-span-3">
                   <div class="shadow-lg rounded-lg border bg-card text-card-foreground">
                      <div class="p-6 text-center">
                        <h2 class="text-2xl font-semibold tracking-tight">ফর্মের প্রিভিউ</h2>
                        <p class="text-sm text-muted-foreground">
                            নিচের ফরম্যাটটি প্রিন্ট লেবেলের মতো দেখাবে (৩.৬” x ৫.৬”)। 
                          <span id="preview-description-extra"></span>
                        </p>
                      </div>
                      <div class="p-6 pt-0">
                        <div id="preview-container">
                          <!-- Preview will be rendered here -->
                        </div>
                      </div>
                   </div>
      
                   <div class="text-center mt-6">
                      <button id="print-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-8 rounded-lg shadow-xl transition duration-150 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 inline-flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="12" height="8" x="6" y="14"></rect></svg>
                        প্রিন্ট করুন
                      </button>
                  </div>
                </div>
              </div>
            </div>
          </main>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // State
            const labelState = {
                serial: "F/",
                patientName: "",
                date: new Date(),
                shakeMode: "with",
                drops: 3,
                shakeCount: 10,
                interval: 12,
                intervalUnit: "hours",
                mixtureAmount: "১ চামচ",
                durationDays: 7,
                counseling: [
                    "• ঔষধ সেবনকালীন যাবতীয় ঔষধি নিষিদ্ধ।",
                    "• ঔষধ সেবনের আধা ঘন্টা আগে-পরে জল ব্যতিত কোন খাবার খাবেন না।",
                    "• জরুরী প্রয়োজনে বিকাল ৫টা থেকে ৭টার মধ্যে ফোন করুন।"
                ],
                labelCount: 1,
                followUpDays: 7,
                showAllPreviews: false,
            };

            let activeLabelIndex = 1;

            // DOM Elements
            const inputs = document.querySelectorAll('input[name], select[name]');
            const previewContainer = document.getElementById('preview-container');
            const dateInput = document.getElementById('date');

            // Utility Functions
            const convertToBanglaNumerals = (text) => {
                if (text === undefined || text === null) return "";
                const banglaDigits = { '0': '০', '1': '১', '2': '২', '3': '৩', '4': '৪', '5': '৫', '6': '৬', '7': '৭', '8': '৮', '9': '৯' };
                return String(text).replace(/[0-9]/g, (digit) => banglaDigits[digit]);
            };

            const formatDate = (date) => {
                const d = new Date(date);
                let day = d.getDate().toString().padStart(2, '0');
                let month = (d.getMonth() + 1).toString().padStart(2, '0');
                let year = d.getFullYear();
                return `${day}/${month}/${year}`;
            };
            
            dateInput.valueAsDate = new Date();

            // Render Functions
            const renderPreview = () => {
                previewContainer.innerHTML = '';
                const count = Number(labelState.labelCount) || 1;

                const generatePreviewHTML = (index) => {
                    const formattedDate = convertToBanglaNumerals(formatDate(labelState.date));
                    const counselingPoints = labelState.counseling.map(line => `<li>${convertToBanglaNumerals(line)}</li>`).join('');
                    const finalCounseling = `${counselingPoints}<li>• <strong>${convertToBanglaNumerals(labelState.followUpDays)} দিন</strong> পরে আসবেন।</li>`;

                    const bnDrops = convertToBanglaNumerals(labelState.drops);
                    const bnInterval = convertToBanglaNumerals(labelState.interval);
                    const bnShakeCount = labelState.shakeMode === 'with' ? convertToBanglaNumerals(labelState.shakeCount) : '';
                    const bnMixtureAmount = convertToBanglaNumerals(labelState.mixtureAmount);
                    const bnDurationDays = convertToBanglaNumerals(labelState.durationDays);
                    const intervalUnitText = labelState.intervalUnit === 'hours' ? 'ঘণ্টা' : 'দিন';

                    let instruction;
                     if (labelState.shakeMode === "with") {
                        instruction = `ঔষধ সেবনের আগে শিশিটিকে হাতের তালুর উপরে দূর হতে সজোরে থেমে থেমে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnShakeCount}</span> বার ঝাঁকি দিয়ে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDrops}</span> ফোঁটা ঔষধ <span class="font-bold">১ কাপ</span> ঠান্ডা জলের সাথে চামচ দিয়ে ভালোভাবে মিশিয়ে নিয়ে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnInterval}</span> ${intervalUnitText} অন্তর <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnMixtureAmount}</span> করে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDurationDays}</span> দিন সেবন করবেন।`;
                    } else {
                        instruction = `প্রতিবার ঔষধ সেবনের পূর্বে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDrops}</span> ফোঁটা ঔষধ <span class="font-bold">১ কাপ</span> ঠান্ডা জলের সাথে চামচ দিয়ে ভালভাবে মিশিয়ে নিয়ে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnInterval}</span> ${intervalUnitText} অন্তর <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnMixtureAmount}</span> করে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDurationDays}</span> দিন সেবন করবেন।`;
                    }
                    
                    let sequentialText = '';
                    if (labelState.labelCount > 1) {
                        const bnIndex = convertToBanglaNumerals(index);
                        if (index > 1) {
                            const prevIndex = convertToBanglaNumerals(index - 1);
                            sequentialText = `${bnIndex} নং ঔষধ (${prevIndex} নং এর পরে খাবেন)`;
                        } else {
                            sequentialText = `${bnIndex} নং ঔষধ`;
                        }
                    }

                    return `
                        <div class="printable-label-wrapper ${labelState.showAllPreviews ? 'mb-4' : ''}">
                            <div class="prescription-sheet font-body bg-white text-black flex flex-col">
                                <div class="flex-grow space-y-4">
                                    <div>
                                        <div class="flex justify-between items-center text-sm font-medium mb-1">
                                            <span class="truncate pr-1">ক্রমিক নং: <strong class="text-indigo-700 font-extrabold">${labelState.serial}</strong></span>
                                            <span class="whitespace-nowrap">তারিখঃ <strong class="text-indigo-700 font-extrabold">${formattedDate}</strong></span>
                                        </div>
                                        <div class="text-left text-base font-medium mb-4">
                                            রোগীর নামঃ <strong class="text-indigo-700 font-extrabold">${labelState.patientName || ''}</strong>
                                        </div>
                                    </div>
                                    ${sequentialText ? `<div class="text-center mb-2"><span class="text-xl font-bold text-red-700 inline-block border border-black rounded-md py-1 px-3">${sequentialText}</span></div>` : ''}
                                    <div class="space-y-3">
                                        <div class="text-center"> 
                                            <h2 class="inline-block border-b-2 border-gray-800 py-0.5 text-center font-extrabold" style="font-size: 17px">ঔষধ খাবার নিয়মাবলী</h2>
                                        </div>
                                        <div class="instruction-box">
                                            <div class="text-gray-800 text-justify leading-snug" style="font-size: 13px">${convertToBanglaNumerals(instruction)}</div>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="text-center">
                                            <h3 class="text-base font-bold text-red-700 mb-1 inline-block border-b-2 border-red-700">পরামর্শ</h3>
                                            <ul class="advice-list text-gray-800 text-xs pl-0 list-none text-left">${finalCounseling}</ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="doctor-info instruction-box text-center mt-auto">
                                    <p class="font-bold mb-0" style="font-size: 0.8rem;">ত্রিফুল আরোগ্য নিকেতন</p>
                                    <p class="mb-0" style="font-size: 0.5rem;">(আদর্শ হোমিওপ্যাথিক চিকিৎসালয়)</p>
                                    <p class="mb-0" style="font-size: 0.7rem;">
                                        <span class="font-medium">ডাঃ নীহার রঞ্জন রায়</span> <span class="font-medium" style="font-size: 0.5rem;">(বি.এস.সি, ডি.এইচ.এম.এস)</span>
                                    </p>
                                    <p class="mb-0" style="font-size: 0.5rem;">(শুধুমাত্র জটিল ও পুরাতন রোগী চিকিৎসক)</p>
                                    <p class="mb-0" style="font-size: 0.6rem;">কোটালীপাড়া, গোপালগঞ্জ</p>
                                    <p class="font-bold mb-0">
                                        <span style="font-size: 0.6rem;">মোবাইল: </span>
                                        <span style="font-size: 0.65rem;">01716954699, 01922788466, 01714-719422</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                };

                if (labelState.showAllPreviews) {
                    for (let i = 1; i <= count; i++) {
                        previewContainer.innerHTML += generatePreviewHTML(i);
                    }
                } else {
                    previewContainer.innerHTML = generatePreviewHTML(activeLabelIndex);
                }
                
                // Update description
                const previewDesc = document.getElementById('preview-description-extra');
                if (!labelState.showAllPreviews && labelState.labelCount > 1) {
                    previewDesc.textContent = ` মোট ${convertToBanglaNumerals(labelState.labelCount)}টি লেবেলের মধ্যে ${convertToBanglaNumerals(activeLabelIndex)} নং লেবেল দেখানো হচ্ছে।`;
                } else {
                    previewDesc.textContent = '';
                }
            };
            
            const renderCounselingList = () => {
                const list = document.getElementById('counseling-list');
                list.innerHTML = '';
                labelState.counseling.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-gray-100 p-2 rounded-md";
                    div.innerHTML = `
                        <span class="text-sm">${item}</span>
                        <button data-index="${index}" class="remove-counseling-btn variant="ghost" size="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="15" x2="9" y1="9" y2="15"></line><line x1="9" x2="15" y1="9" y2="15"></line></svg>
                        </button>
                    `;
                    list.appendChild(div);
                });

                document.querySelectorAll('.remove-counseling-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.currentTarget.getAttribute('data-index'));
                        labelState.counseling = labelState.counseling.filter((_, i) => i !== indexToRemove);
                        renderCounselingList();
                        renderPreview();
                    });
                });
            };

            // Event Handlers
            const handleStateChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (type === 'checkbox') {
                    labelState[name] = checked;
                } else if (type === 'radio') {
                    labelState[name] = value;
                } else if (type === 'date') {
                    labelState[name] = new Date(value);
                } else if (type === 'number') {
                     labelState[name] = value === '' ? '' : parseInt(value, 10);
                } else {
                    labelState[name] = value;
                }
                
                updateUI();
            };

            const updateUI = () => {
                // Handle shake count visibility
                document.getElementById('shake-count-wrapper').style.display = labelState.shakeMode === 'with' ? 'block' : 'none';

                // Handle interval unit text
                document.getElementById('interval-unit-text').textContent = labelState.intervalUnit === 'hours' ? 'ঘন্টা' : 'দিন';
                
                // Handle label count UI
                const labelCount = Number(labelState.labelCount) || 1;
                const showAllWrapper = document.getElementById('show-all-wrapper');
                const sliderWrapper = document.getElementById('slider-wrapper');
                const slider = document.getElementById('activeLabelIndex');
                
                if (labelCount > 1) {
                    showAllWrapper.style.display = 'flex';
                    slider.max = labelCount;
                    if (activeLabelIndex > labelCount) {
                        activeLabelIndex = labelCount;
                        slider.value = labelCount;
                    }
                    sliderWrapper.style.display = labelState.showAllPreviews ? 'none' : 'block';
                } else {
                    showAllWrapper.style.display = 'none';
                    sliderWrapper.style.display = 'none';
                }
                document.getElementById('active-label-text').textContent = convertToBanglaNumerals(activeLabelIndex);


                renderPreview();
            };
            
            // Initialization and Event Listeners
            inputs.forEach(input => {
                input.addEventListener('input', handleStateChange);
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', handleStateChange);
            });

            document.getElementById('showAllPreviews').addEventListener('change', handleStateChange);

            const activeLabelSlider = document.getElementById('activeLabelIndex');
            activeLabelSlider.addEventListener('input', (e) => {
                activeLabelIndex = parseInt(e.target.value);
                updateUI();
            });

            // Shake mode radio buttons special handling for UI update
            document.getElementById('shakeMode').addEventListener('change', (e) => {
                 const selected = e.target.closest('input[type="radio"]');
                 if(selected) {
                    document.querySelectorAll('#shakeMode label').forEach(l => l.classList.remove('bg-indigo-600', 'text-white'));
                    document.querySelectorAll('#shakeMode label').forEach(l => l.classList.add('bg-gray-200', 'text-gray-700'));
                    document.querySelector(`label[for=${selected.id}]`).classList.add('bg-indigo-600', 'text-white');
                    document.querySelector(`label[for=${selected.id}]`).classList.remove('bg-gray-200', 'text-gray-700');
                    labelState.shakeMode = selected.value;
                    updateUI();
                 }
            });

            // Counseling collapsible
            const counselingTrigger = document.getElementById('counseling-trigger');
            counselingTrigger.addEventListener('click', () => {
                counselingTrigger.classList.toggle('open');
                const icon = counselingTrigger.querySelector('svg');
                icon.classList.toggle('rotate-180');
            });

            // Add counseling
            document.getElementById('add-counseling-btn').addEventListener('click', () => {
                const select = document.getElementById('counseling-select');
                const newCounseling = select.value;
                if(newCounseling && !labelState.counseling.includes(newCounseling)) {
                    labelState.counseling.push(newCounseling);
                    renderCounselingList();
                    renderPreview();
                }
            });

            // Print button
            document.getElementById('print-button').addEventListener('click', () => {
                 const container = document.getElementById('preview-container');
                if (!container) return;

                const printableContent = document.createElement('div');
                printableContent.id = 'printable-content';

                const previews = container.querySelectorAll('.printable-label-wrapper');

                previews.forEach(previewNode => {
                    const sheet = document.createElement('div');
                    sheet.className = "print-page";
                    const content = previewNode.cloneNode(true);
                    sheet.appendChild(content);
                    printableContent.appendChild(sheet);
                });

                if (printableContent.hasChildNodes()) {
                    document.body.appendChild(printableContent);
                    window.print();
                    document.body.removeChild(printableContent);
                }
            });
            
            // Voice Typing
            const micButton = document.getElementById('mic-button');
            const patientNameInput = document.getElementById('patientName');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'bn-BD';
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    micButton.classList.add('animate-pulse');
                    micButton.querySelector('svg').classList.add('text-red-500');
                };

                recognition.onend = () => {
                    micButton.classList.remove('animate-pulse');
                    micButton.querySelector('svg').classList.remove('text-red-500');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    labelState.patientName = patientNameInput.value ? `${patientNameInput.value} ${transcript}` : transcript;
                    patientNameInput.value = labelState.patientName;
                    renderPreview();
                };

                micButton.addEventListener('click', () => {
                    recognition.start();
                });

            } else {
                micButton.style.display = 'none';
            }


            // Initial Render
            renderCounselingList();
            updateUI();
        });
    </script>
</body>
</html>
