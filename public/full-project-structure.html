<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ত্রিফুল আরোগ্য নিকেতন - সম্পূর্ণ প্রজেক্ট কাঠামো</title>
  <style>
    /* Inlined globals.css */
    @tailwind base;
    @tailwind components;
    @tailwind utilities;

    @layer base {
      :root {
        --background: 220 20% 97%; /* Muted light blue-gray */
        --foreground: 220 15% 20%;
        --card: 0 0% 100%;
        --card-foreground: 220 15% 20%;
        --popover: 0 0% 100%;
        --popover-foreground: 220 15% 20%;
        --primary: 230 80% 60%; /* Indigo-like blue */
        --primary-foreground: 0 0% 100%;
        --secondary: 220 15% 90%;
        --secondary-foreground: 220 15% 20%;
        --muted: 220 15% 90%;
        --muted-foreground: 220 10% 45%;
        --accent: 220 20% 94%;
        --accent-foreground: 220 15% 20%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 0 0% 98%;
        --border: 220 15% 85%;
        --input: 220 15% 85%;
        --ring: 230 80% 60%;
        --chart-1: 12 76% 61%;
        --chart-2: 173 58% 39%;
        --chart-3: 197 37% 24%;
        --chart-4: 43 74% 66%;
        --chart-5: 27 87% 67%;
        --radius: 0.5rem;
      }
    }

    @layer base {
      * {
        border-color: hsl(var(--border));
      }
      body {
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
      }
    }
    
    .prescription-sheet {
        padding: 2rem 1.5rem; 
        max-width: 450px;
        height: 660px;
        margin: 2rem auto;
        background-color: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .instruction-box {
        border: 1px dashed #6b7280;
        padding: 0.75rem; 
        margin-top: 0.5rem;
        line-height: 1.6;
    }

    .advice-list li {
        margin-bottom: 0.1rem; 
    }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            body: ['"Hind Siliguri"', '"Inter"', 'sans-serif'],
          },
          colors: {
            background: 'hsl(var(--background))',
            foreground: 'hsl(var(--foreground))',
            card: {
              DEFAULT: 'hsl(var(--card))',
              foreground: 'hsl(var(--card-foreground))',
            },
            popover: {
              DEFAULT: 'hsl(var(--popover))',
              foreground: 'hsl(var(--popover-foreground))',
            },
            primary: {
              DEFAULT: 'hsl(var(--primary))',
              foreground: 'hsl(var(--primary-foreground))',
            },
            secondary: {
              DEFAULT: 'hsl(var(--secondary))',
              foreground: 'hsl(var(--secondary-foreground))',
            },
            muted: {
              DEFAULT: 'hsl(var(--muted))',
              foreground: 'hsl(var(--muted-foreground))',
            },
            accent: {
              DEFAULT: 'hsl(var(--accent))',
              foreground: 'hsl(var(--accent-foreground))',
            },
            destructive: {
              DEFAULT: 'hsl(var(--destructive))',
              foreground: 'hsl(var(--destructive-foreground))',
            },
            border: 'hsl(var(--border))',
            input: 'hsl(var(--input))',
            ring: 'hsl(var(--ring))',
          }
        }
      }
    }
  </script>
</head>
<body class="font-body antialiased">

  <!-- Section: Main Application Page -->
  <section id="home-page" class="min-h-screen p-4 sm:p-6 lg:p-8 bg-background">
    <div class="max-w-7xl mx-auto space-y-8">
      <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h1 class="text-4xl font-bold tracking-tight font-body text-indigo-700">
            ত্রিফুল আরোগ্য নিকেতন
          </h1>
          <p class="text-sm text-muted-foreground mt-1">
            প্রয়োজনীয় তথ্য দিয়ে ঔষধের লেবেল তৈরি এবং প্রিন্ট করুন।
          </p>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
        <!-- Component: LabelForm -->
        <div id="label-form-container" class="lg:col-span-2 rounded-lg border bg-card text-card-foreground shadow-sm">
          <div class="flex flex-col space-y-1.5 p-6">
            <h3 class="text-2xl font-semibold leading-none tracking-tight font-body">রোগীর তথ্য ও নির্দেশাবলী</h3>
          </div>
          <div class="p-6 pt-0">
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="serial" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">ক্রমিক নং</label>
                        <input id="serial" name="serial" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    </div>
                    <div>
                        <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">তারিখ</label>
                        <input type="date" id="date" name="date" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    </div>
                </div>

                <div>
                    <label for="patientName" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">রোগীর নাম</label>
                    <input id="patientName" name="patientName" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>

                <div class="mb-6">
                    <div role="radiogroup" class="flex flex-wrap gap-4">
                        <div class="flex items-center">
                            <input type="radio" value="with" id="with-shake" name="shakeMode" class="peer sr-only">
                            <label for="with-shake" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 border-2 border-transparent hover:border-indigo-600 font-semibold transition duration-150 cursor-pointer">ঝাঁকি সহ</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" value="without" id="without-shake" name="shakeMode" class="peer sr-only">
                            <label for="without-shake" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 border-2 border-transparent hover:border-indigo-600 font-semibold transition duration-150 cursor-pointer">ঝাঁকি ছাড়া</label>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shake-drops-section">
                         <div id="shake-count-wrapper">
                            <label for="shakeCount" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কত বার ঝাঁকি দিবেন?</label>
                            <input id="shakeCount" name="shakeCount" type="number" min="1" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                        <div>
                            <label for="drops" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কত ফোঁটা করে খাবেন?</label>
                            <input id="drops" name="drops" type="number" min="1" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="interval" id="interval-label" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কত ঘন্টা পর পর খাবেন?</label>
                            <input id="interval" name="interval" type="number" min="1" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            <div role="radiogroup" class="flex gap-4 mt-2">
                                <div class="flex items-center space-x-2">
                                    <input type="radio" value="hours" id="hours" name="intervalUnit">
                                    <label for="hours">ঘণ্টা</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="radio" value="days" id="days" name="intervalUnit">
                                    <label for="days">দিন</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="mixtureAmount" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কিভাবে খাবেন?</label>
                            <select id="mixtureAmount" name="mixtureAmount" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                                <option value="১ চামচ">১ চামচ</option>
                                <option value="২ চামচ">২ চামচ</option>
                                <option value="৩ চামচ">৩ চামচ</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="durationDays" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কত দিন খাবেন?</label>
                            <input id="durationDays" name="durationDays" type="number" min="1" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                        <div>
                            <label for="labelCount" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কতগুলো লেবেল?</label>
                            <input id="labelCount" name="labelCount" type="number" min="1" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                        <div>
                            <label for="followUpDays" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">কত দিন পরে আসবেন?</label>
                            <input id="followUpDays" name="followUpDays" type="number" min="1" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                    </div>
                </div>
                
                <div id="collapsible-counseling" class="space-y-4 pt-4 border-t">
                    <button id="collapsible-trigger" type="button" class="flex w-full justify-between items-center text-lg font-semibold">
                      <h3>পরামর্শ</h3>
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 transition-transform">
                          <path d="m6 9 6 6 6-6"></path>
                      </svg>
                    </button>
                    <div id="collapsible-content" class="space-y-4" style="display: none;">
                        <div class="space-y-2">
                            <label class="text-sm font-medium leading-none">বর্তমান পরামর্শসমূহ:</label>
                            <div id="current-counseling-list" class="space-y-1"></div>
                        </div>

                        <div class="space-y-2">
                            <label for="counseling-select" class="text-sm font-medium leading-none">নতুন পরামর্শ যোগ করুন</label>
                            <div class="flex gap-2">
                                <select id="counseling-select" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                                </select>
                                <button id="add-counseling-btn" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                                    যোগ করুন
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div id="preview-options-container" class="flex items-center gap-4" style="display: none;">
                        <div class="flex items-center space-x-2 pt-6">
                            <input type="checkbox" id="showAllPreviews" class="peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground">
                            <label for="showAllPreviews" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">সকল প্রিভিউ দেখুন</label>
                        </div>
                    </div>
                    <div id="slider-container" class="space-y-2" style="display: none;">
                        <label id="slider-label" class="text-sm font-medium leading-none">কোন লেবেলটি প্রিভিউ করবেন?</label>
                        <input type="range" id="activeLabelSlider" name="activeLabelSlider" min="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>
            <!-- End LabelForm -->
          </div>
        </div>

        <!-- Component: LabelPreview -->
        <div class="lg:col-span-3">
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="text-center flex flex-col space-y-1.5 p-6">
                    <h2 class="text-2xl font-semibold leading-none tracking-tight">ফর্মের প্রিভিউ</h2>
                    <p id="preview-description" class="text-sm text-muted-foreground">
                        নিচের ফরম্যাটটি প্রিন্ট লেবেলের মতো দেখাবে।
                    </p>
                </div>
                <div class="p-6 pt-0">
                    <div id="preview-container">
                        <!-- Preview will be rendered here by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="print-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-8 rounded-lg shadow-xl transition duration-150 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 inline-flex items-center justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="6" height="8" width="12" y="14"></rect></svg>
                  প্রিন্ট করুন
                </button>
            </div>
        </div>
        <!-- End LabelPreview -->
      </div>
    </div>
  </section>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // STATE MANAGEMENT
        const labelState = {
            serial: "F/",
            patientName: "",
            date: new Date(),
            shakeMode: "with",
            drops: 3,
            shakeCount: 10,
            interval: 12,
            intervalUnit: "hours",
            mixtureAmount: "১ চামচ",
            durationDays: 7,
            counseling: [
                "• ঔষধ সেবনকালীন যাবতীয় ঔষধি নিষিদ্ধ।",
                "• ঔষধ সেবনের আধা ঘন্টা আগে-পরে জল ব্যতিত কোন খাবার খাবেন না।",
                "• জরুরী প্রয়োজনে বিকাল ৫টা থেকে ৭টার মধ্যে ফোন করুন।"
            ],
            labelCount: 1,
            followUpDays: 7,
            showAllPreviews: false,
            activeLabelIndex: 1
        };

        const predefinedCounseling = [
            "• ঔষধ সেবনকালীন টক খাওয়া নিষেধ।",
            "• ঔষধ সেবনকালীন দুধ, ডিম, মাংস খাওয়া নিষেধ।",
            "• গোরুর মাংস খাওয়া একদম নিষেধ।",
        ];

        // ELEMENT SELECTORS
        const elements = {
            serial: document.getElementById('serial'),
            patientName: document.getElementById('patientName'),
            date: document.getElementById('date'),
            shakeMode: document.querySelectorAll('input[name="shakeMode"]'),
            drops: document.getElementById('drops'),
            shakeCount: document.getElementById('shakeCount'),
            interval: document.getElementById('interval'),
            intervalUnit: document.querySelectorAll('input[name="intervalUnit"]'),
            mixtureAmount: document.getElementById('mixtureAmount'),
            durationDays: document.getElementById('durationDays'),
            labelCount: document.getElementById('labelCount'),
            followUpDays: document.getElementById('followUpDays'),
            showAllPreviews: document.getElementById('showAllPreviews'),
            activeLabelSlider: document.getElementById('activeLabelSlider'),
            previewContainer: document.getElementById('preview-container'),
            printButton: document.getElementById('print-button'),
            intervalLabel: document.getElementById('interval-label'),
            shakeCountWrapper: document.getElementById('shake-count-wrapper'),
            sliderContainer: document.getElementById('slider-container'),
            sliderLabel: document.getElementById('slider-label'),
            previewDescription: document.getElementById('preview-description'),
            previewOptionsContainer: document.getElementById('preview-options-container'),
            currentCounselingList: document.getElementById('current-counseling-list'),
            counselingSelect: document.getElementById('counseling-select'),
            addCounselingBtn: document.getElementById('add-counseling-btn'),
            collapsibleTrigger: document.getElementById('collapsible-trigger'),
            collapsibleContent: document.getElementById('collapsible-content')
        };
        
        // UTILITY FUNCTIONS
        const convertToBanglaNumerals = (text) => {
            if (text === undefined || text === null) return "";
            const banglaDigits = {
                '0': '০', '1': '১', '2': '২', '3': '৩', '4': '৪',
                '5': '৫', '6': '৬', '7': '৭', '8': '৮', '9': '৯'
            };
            return String(text).replace(/[0-9]/g, (digit) => banglaDigits[digit]);
        };

        const formatDate = (date) => {
            if (!(date instanceof Date) || isNaN(date)) {
                date = new Date();
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };

        // RENDER/UPDATE FUNCTIONS
        const updatePreview = () => {
            elements.previewContainer.innerHTML = '';
            
            const count = Number(labelState.labelCount) || 1;
            
            if (labelState.showAllPreviews) {
                 Array.from({ length: count }, (_, i) => i + 1).forEach(index => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'printable-label-wrapper mb-4';
                    wrapper.innerHTML = generatePreviewHTML(index);
                    elements.previewContainer.appendChild(wrapper);
                 });
            } else {
                const wrapper = document.createElement('div');
                wrapper.className = 'printable-label-wrapper';
                wrapper.innerHTML = generatePreviewHTML(labelState.activeLabelIndex);
                elements.previewContainer.appendChild(wrapper);
            }
            updateUI();
        };
        
        const generatePreviewHTML = (activeIndex) => {
            const formattedDate = convertToBanglaNumerals(formatDate(labelState.date));
            
            const counselingPoints = labelState.counseling
                .map(line => `<li>${convertToBanglaNumerals(line)}</li>`).join('');
            const finalCounseling = `${counselingPoints}<li>• <strong>${convertToBanglaNumerals(labelState.followUpDays)} দিন</strong> পরে আসবেন।</li>`;

            const bnDrops = convertToBanglaNumerals(labelState.drops);
            const bnInterval = convertToBanglaNumerals(labelState.interval);
            const bnShakeCount = labelState.shakeMode === 'with' ? convertToBanglaNumerals(labelState.shakeCount) : '';
            const bnMixtureAmount = convertToBanglaNumerals(labelState.mixtureAmount);
            const bnDurationDays = convertToBanglaNumerals(labelState.durationDays);
            const intervalUnitText = labelState.intervalUnit === 'hours' ? 'ঘণ্টা' : 'দিন';

            let instruction;
            if (labelState.shakeMode === "with") {
                instruction = `ঔষধ সেবনের আগে শিশিটিকে হাতের তালুর উপরে দূর হতে সজোরে থেমে থেমে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnShakeCount}</span> বার ঝাঁকি দিয়ে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDrops}</span> ফোঁটা ঔষধ <span class="font-bold">১ কাপ</span> ঠান্ডা জলের সাথে চামচ দিয়ে ভালোভাবে মিশিয়ে নিয়ে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnInterval}</span> ${intervalUnitText} অন্তর <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnMixtureAmount}</span> করে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDurationDays}</span> দিন সেবন করবেন।`;
            } else {
                instruction = `প্রতিবার ঔষধ সেবনের পূর্বে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDrops}</span> ফোঁটা ঔষধ <span class="font-bold">১ কাপ</span> ঠান্ডা জলের সাথে চামচ দিয়ে ভালভাবে মিশিয়ে নিয়ে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnInterval}</span> ${intervalUnitText} অন্তর <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnMixtureAmount}</span> করে <span class="text-red-700 font-extrabold" style="font-size: 13px;">${bnDurationDays}</span> দিন সেবন করবেন।`;
            }

            let sequentialText = '';
            if (labelState.labelCount > 1) {
                const bnIndex = convertToBanglaNumerals(activeIndex);
                let text;
                if (activeIndex > 1) {
                    const prevIndex = convertToBanglaNumerals(activeIndex - 1);
                    text = `${bnIndex} নং ঔষধ (${prevIndex} নং এর পরে খাবেন)`;
                } else {
                    text = `${bnIndex} নং ঔষধ`;
                }
                sequentialText = `
                <div class="text-center mb-2">
                    <span class="text-xl font-bold text-red-700 inline-block border border-black rounded-md py-1 px-3">
                    ${text}
                    </span>
                </div>`;
            }

            return `
              <div class="prescription-sheet font-body bg-white text-black flex flex-col">
                  <div class="flex-grow space-y-4">
                      <div>
                          <div class="flex justify-between items-center text-sm font-medium mb-1">
                              <span class="truncate pr-1">ক্রমিক নং: <strong class="text-indigo-700 font-extrabold">${labelState.serial}</strong></span>
                              <span class="whitespace-nowrap">তারিখঃ <strong class="text-indigo-700 font-extrabold">${formattedDate}</strong></span>
                          </div>
                          <div class="text-left text-base font-medium mb-4">
                              রোগীর নামঃ <strong class="text-indigo-700 font-extrabold">${labelState.patientName || ''}</strong>
                          </div>
                      </div>

                      ${sequentialText}

                      <div class="space-y-3">
                          <div class="text-center"> 
                              <h2 class="inline-block border-b-2 border-gray-800 py-0.5 text-center font-extrabold" style="font-size: 17px;">ঔষধ খাবার নিয়মাবলী</h2>
                          </div>
                          <div class="instruction-box text-gray-800 text-justify leading-snug" style="font-size: 13px;">
                            ${instruction}
                          </div>
                      </div>

                      <div class="space-y-4">
                          <div class="text-center">
                            <h3 class="text-base font-bold text-red-700 mb-1 inline-block border-b-2 border-red-700">পরামর্শ</h3>
                            <ul class="advice-list text-gray-800 text-xs pl-0 list-none text-left">
                                ${finalCounseling}
                            </ul>
                          </div>
                      </div>
                  </div>
                
                <div class="doctor-info instruction-box text-center mt-auto">
                    <p class="font-bold mb-0" style="font-size: 0.8rem;">ত্রিফুল আরোগ্য নিকেতন</p>
                    <p class="mb-0" style="font-size: 0.5rem;">(আদর্শ হোমিওপ্যাথিক চিকিৎসালয়)</p>
                    <p class="mb-0" style="font-size: 0.7rem;">
                      <span class="font-medium">ডাঃ নীহার রঞ্জন রায়</span> <span class="font-medium" style="font-size: 0.5rem;">(বি.এস.সি, ডি.এইচ.এম.এস)</span>
                    </p>
                    <p class="mb-0" style="font-size: 0.5rem;">(শুধুমাত্র জটিল ও পুরাতন রোগী চিকিৎসক)</p>
                    <p class="mb-0" style="font-size: 0.6rem;">কোটালীপাড়া, গোপালগঞ্জ</p>
                    <p class="font-bold mb-0">
                      <span style="font-size: 0.6rem;">মোবাইল: </span>
                      <span style="font-size: 0.65rem;">01716954699, 01922788466, 01714-719422</span>
                    </p>
                </div>
              </div>
            `;
        };

        const updateCounselingList = () => {
            elements.currentCounselingList.innerHTML = '';
            labelState.counseling.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-md';
                div.innerHTML = `
                    <span class="text-sm">${item}</span>
                    <button data-index="${index}" class="remove-counseling-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                    </button>
                `;
                elements.currentCounselingList.appendChild(div);
            });

            document.querySelectorAll('.remove-counseling-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                    labelState.counseling = labelState.counseling.filter((_, i) => i !== indexToRemove);
                    updateCounselingList();
                    updatePreview();
                });
            });
        };

        const updateUI = () => {
            // Shake mode UI
            elements.shakeCountWrapper.style.display = labelState.shakeMode === 'with' ? 'block' : 'none';

            // Interval unit UI
            elements.intervalLabel.textContent = `কত ${labelState.intervalUnit === 'hours' ? 'ঘন্টা' : 'দিন'} পর পর খাবেন?`;

            // Preview options UI
            const count = Number(labelState.labelCount);
            if (count > 1) {
                elements.previewOptionsContainer.style.display = 'flex';
                elements.sliderContainer.style.display = labelState.showAllPreviews ? 'none' : 'block';
                elements.activeLabelSlider.max = count;
                elements.activeLabelSlider.value = labelState.activeLabelIndex;
                elements.sliderLabel.textContent = `কোন লেবেলটি প্রিভিউ করবেন? (${convertToBanglaNumerals(labelState.activeLabelIndex)})`;
                elements.previewDescription.textContent = `নিচের ফরম্যাটটি প্রিন্ট লেবেলের মতো দেখাবে। ${!labelState.showAllPreviews ? ` মোট ${convertToBanglaNumerals(count)}টি লেবেলের মধ্যে ${convertToBanglaNumerals(labelState.activeLabelIndex)} নং লেবেল দেখানো হচ্ছে।` : ''}`;
            } else {
                elements.previewOptionsContainer.style.display = 'none';
                elements.sliderContainer.style.display = 'none';
                 elements.previewDescription.textContent = `নিচের ফরম্যাটটি প্রিন্ট লেবেলের মতো দেখাবে।`;
            }
        };

        // EVENT HANDLERS
        const handleInputChange = (e) => {
            const { name, value, type } = e.target;
            if (type === 'number') {
                labelState[name] = value === '' ? '' : parseInt(value, 10);
                if (name === 'labelCount' && (parseInt(value, 10) < 1 || isNaN(parseInt(value, 10)))) {
                    if (document.activeElement !== e.target) { // only reset if blurred
                        labelState.labelCount = 1;
                        elements.labelCount.value = 1;
                    }
                }
            } else if (type === 'date') {
                labelState[name] = new Date(value);
            } 
            else {
                labelState[name] = value;
            }
            updatePreview();
        };
        
        // INITIALIZATION
        function initializeForm() {
            // Set initial values
            elements.serial.value = labelState.serial;
            elements.patientName.value = labelState.patientName;
            elements.date.valueAsDate = labelState.date;
            document.querySelector(`input[name="shakeMode"][value="${labelState.shakeMode}"]`).checked = true;
            elements.drops.value = labelState.drops;
            elements.shakeCount.value = labelState.shakeCount;
            elements.interval.value = labelState.interval;
            document.querySelector(`input[name="intervalUnit"][value="${labelState.intervalUnit}"]`).checked = true;
            elements.mixtureAmount.value = labelState.mixtureAmount;
            elements.durationDays.value = labelState.durationDays;
            elements.labelCount.value = labelState.labelCount;
            elements.followUpDays.value = labelState.followUpDays;
            elements.showAllPreviews.checked = labelState.showAllPreviews;

            // Populate counseling select
            predefinedCounseling.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                elements.counselingSelect.appendChild(option);
            });
            
            // Add event listeners
            ['serial', 'patientName', 'date', 'drops', 'shakeCount', 'interval', 'mixtureAmount', 'durationDays', 'followUpDays'].forEach(id => {
                document.getElementById(id).addEventListener('input', handleInputChange);
            });
             elements.labelCount.addEventListener('input', handleInputChange);
             elements.labelCount.addEventListener('blur', (e) => {
                 if(e.target.value === '' || parseInt(e.target.value, 10) < 1) {
                    e.target.value = 1;
                    labelState.labelCount = 1;
                    updatePreview();
                 }
             });

            elements.shakeMode.forEach(radio => radio.addEventListener('change', (e) => {
                labelState.shakeMode = e.target.value;
                updatePreview();
            }));
            elements.intervalUnit.forEach(radio => radio.addEventListener('change', (e) => {
                labelState.intervalUnit = e.target.value;
                updatePreview();
            }));

            elements.showAllPreviews.addEventListener('change', (e) => {
                labelState.showAllPreviews = e.target.checked;
                updatePreview();
            });

            elements.activeLabelSlider.addEventListener('input', (e) => {
                labelState.activeLabelIndex = parseInt(e.target.value, 10);
                updatePreview();
            });

            elements.addCounselingBtn.addEventListener('click', () => {
                const selected = elements.counselingSelect.value;
                if(selected && !labelState.counseling.includes(selected)) {
                    labelState.counseling.push(selected);
                    updateCounselingList();
                    updatePreview();
                }
            });
            
            elements.collapsibleTrigger.addEventListener('click', () => {
                const content = elements.collapsibleContent;
                const icon = elements.collapsibleTrigger.querySelector('svg');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                }
            });

            elements.printButton.addEventListener('click', () => {
                const container = elements.previewContainer;
                if (!container) return;

                const printableContent = document.createElement('div');
                const tempStyle = document.createElement('style');
                tempStyle.innerHTML = `
                    @media print {
                      body > *:not(#printable-content) { display: none !important; }
                      #printable-content {
                        display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0;
                      }
                      .print-page {
                        page-break-after: always; display: flex !important; align-items: center; justify-content: center;
                        background-color: white !important; width: 100% !important; height: 100% !important;
                        padding: 0 !important; margin: 0 !important; border: none !important; box-shadow: none !important; font-size: 10pt !important;
                      }
                      .print-page .prescription-sheet {
                        max-width: 3.6in !important; height: 5.6in !important; padding: 0.25in !important;
                        margin: 0 !important; border: 1px solid black !important; box-shadow: none !important;
                      }
                       .print-page .text-red-700 { color: #b91c1c !important; }
                       .print-page .text-indigo-700 { color: #4338ca !important; }
                       .print-page .instruction-box { border: 1px dashed #6b7280 !important; }
                    }
                    @page { size: 3.6in 5.6in; margin: 0.1in; }
                `;
                document.head.appendChild(tempStyle);

                const previews = container.querySelectorAll('.printable-label-wrapper');
                previews.forEach(previewNode => {
                    const sheet = document.createElement('div');
                    sheet.className = "print-page";
                    sheet.appendChild(previewNode.firstElementChild.cloneNode(true));
                    printableContent.appendChild(sheet);
                });

                if (printableContent.hasChildNodes()) {
                    document.body.appendChild(printableContent);
                    window.print();
                    document.body.removeChild(printableContent);
                    document.head.removeChild(tempStyle);
                }
            });
            
            // Initial render
            updateCounselingList();
            updatePreview();
        }

        initializeForm();
    });
  </script>

</body>
</html>
